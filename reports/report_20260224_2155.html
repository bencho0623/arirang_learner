<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Arirang Learner Report</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --ink: #1f2937;
      --muted: #6b7280;
      --line: #dbe1ea;
      --accent: #1e40af;
      --good: #15803d;
      --warn: #b45309;
      --bad: #b91c1c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: "Segoe UI", "Noto Sans KR", sans-serif;
    }
    .container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      gap: 16px;
    }
    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
    }
    .hero {
      color: #fff;
      border: 0;
      background:
        radial-gradient(circle at 80% 20%, rgba(255,255,255,0.22), transparent 35%),
        linear-gradient(135deg, #1d4ed8 0%, #0f766e 55%, #0b132b 100%);
    }
    .hero h1 { margin: 0 0 8px; font-size: 24px; }
    .hero .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      font-size: 14px;
      opacity: 0.95;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.2);
      font-weight: 600;
    }
    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .cefr-chart {
      display: flex;
      align-items: end;
      gap: 8px;
      min-height: 74px;
    }
    .cefr-col {
      width: 34px;
      text-align: center;
      font-size: 11px;
      color: #e2e8f0;
    }
    .cefr-bar {
      width: 100%;
      border-radius: 8px 8px 2px 2px;
      background: rgba(255,255,255,0.86);
      margin-bottom: 4px;
      min-height: 6px;
    }
    .audio-wrap { display: block; }
    audio { width: 100%; }
    .script-box {
      max-height: 400px;
      overflow: auto;
      white-space: pre-wrap;
      line-height: 1.7;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fbfdff;
    }
    .script-box.expanded {
      max-height: none;
    }
    .script-tools {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }
    .script-hint {
      font-size: 12px;
      color: var(--muted);
    }
    .script-toggle {
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    mark {
      background: transparent;
      cursor: pointer;
      padding: 0 1px;
      border-radius: 2px;
      transition: background 0.15s ease;
    }
    mark:hover { background: rgba(59,130,246,0.12); }
    .mark-b2 { border-bottom: 3px solid #facc15; }
    .mark-c1 { border-bottom: 3px solid #fb923c; }
    .mark-c2 { border-bottom: 3px solid #ef4444; }
    .cards-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .v-card {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      background: #fff;
      position: relative;
    }
    .v-card.bookmarked {
      border: 2px solid #f59e0b;
      box-shadow: 0 0 0 2px rgba(245,158,11,0.15) inset;
    }
    .card-top {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 8px;
      padding-right: 28px;
    }
    .word { font-size: 20px; font-weight: 700; }
    .cefr {
      font-size: 11px;
      font-weight: 700;
      border-radius: 999px;
      border: 1px solid var(--line);
      padding: 2px 8px;
    }
    .phonetic { color: var(--muted); font-size: 13px; }
    .sub {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 8px;
    }
    .bookmark-btn {
      position: absolute;
      right: 8px;
      top: 8px;
      border: 0;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
    }
    .bookmark-btn[aria-pressed="true"] { filter: saturate(160%); }
    .card-body { display: none; margin-top: 8px; }
    .v-card.open .card-body { display: block; }
    .def-box {
      background: #f3f4f6;
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .ko {
      color: var(--good);
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .example {
      font-style: italic;
      color: #374151;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .context {
      border-left: 4px solid #3b82f6;
      padding: 8px;
      background: #eff6ff;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .tag {
      border: 1px solid var(--line);
      border-radius: 999px;
      font-size: 12px;
      padding: 2px 8px;
      color: #374151;
      background: #fff;
    }
    .quiz-list { display: grid; gap: 12px; }
    .q {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #fff;
    }
    .q .stem { margin-bottom: 8px; }
    .choices {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
    }
    .choice {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 8px;
      padding: 8px;
      text-align: left;
      cursor: pointer;
    }
    .choice.correct { background: #dcfce7; border-color: #16a34a; }
    .choice.wrong { background: #fee2e2; border-color: #ef4444; }
    .q-result {
      margin-top: 8px;
      font-size: 13px;
      color: #334155;
    }
    .progress {
      height: 10px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress > i {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #16a34a, #22c55e);
      transition: width 0.2s ease;
    }
    @media (max-width: 600px) {
      .cards-grid { grid-template-columns: 1fr; }
      .choices { grid-template-columns: 1fr; }
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b1220;
        --card: #111827;
        --ink: #e5e7eb;
        --muted: #9ca3af;
        --line: #253041;
      }
      .script-box { background: #0f172a; }
      .def-box { background: #1f2937; }
      .context { background: #0b2947; }
      .choice { background: #0f172a; }
      .q { background: #111827; }
    }
    @media print {
      .audio-wrap, .quiz-section { display: none !important; }
      .v-card .card-body { display: block !important; }
      .container { max-width: 100%; padding: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <section class="panel hero">
      <h1 id="news-title"></h1>
      <div class="meta" id="news-meta"></div>
      <div class="header-row">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <span class="badge" id="vocab-count-badge"></span>
          <span class="badge" id="bookmark-count-badge">Î∂ÅÎßàÌÅ¨ 0Í∞ú</span>
        </div>
        <div class="cefr-chart" id="cefr-chart"></div>
      </div>
    </section>

    <section class="panel audio-wrap" id="audio-section">
      <h2>Audio Player</h2>
      <audio controls id="audio-player"></audio>
    </section>

    <section class="panel">
      <h2>Script Viewer</h2>
      <div class="script-tools">
        <div class="script-hint">Ïä§ÌÅ¨Î°§Î°ú Ï†ÑÏ≤¥ ÌôïÏù∏ Í∞ÄÎä• ¬∑ ÌïÑÏöî Ïãú Ï†ÑÏ≤¥Î≥¥Í∏∞</div>
        <button id="script-toggle" class="script-toggle" type="button">Ï†ÑÏ≤¥Î≥¥Í∏∞</button>
      </div>
      <div class="script-box" id="script-box"></div>
    </section>

    <section class="panel">
      <div class="cards-head">
        <h2 style="margin:0;">Vocabulary Cards</h2>
      </div>
      <div class="cards-grid" id="cards-grid"></div>
    </section>

    <section class="panel quiz-section" id="quiz-section">
      <h2>ÎπàÏπ∏ ÌÄ¥Ï¶à</h2>
      <div id="quiz-score">0 / 0</div>
      <div class="progress"><i id="quiz-progress"></i></div>
      <div class="quiz-list" id="quiz-list" style="margin-top:12px;"></div>
    </section>
  </div>

  <script>
    const episode = {"date_display": "2026.02.24", "airtime": "21:55", "title": "t", "mp3_filename": "", "script_text": "hello world hello"};
    const rawVocabData = [{"word": "hello", "lemma": "hello", "cefr_level": "B2", "pos_ko": "Î™ÖÏÇ¨", "frequency_score": 5.2, "phonetic": "", "definition_en": "greet", "translation_ko": "ÏïàÎÖï", "example_en": "hello there", "context_sentence": "hello world", "derivatives": []}];
    const vocabData = JSON.parse(JSON.stringify(rawVocabData));
    const bookmarksKey = "arirang_bookmarks";

    function escHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function loadBookmarks() {
      try {
        return JSON.parse(localStorage.getItem(bookmarksKey) || "{}");
      } catch (_) {
        return {};
      }
    }

    function saveBookmarks(bm) {
      localStorage.setItem(bookmarksKey, JSON.stringify(bm));
    }

    function cefrClass(level) {
      if (level === "C2") return "mark-c2";
      if (level === "C1") return "mark-c1";
      if (level === "B2") return "mark-b2";
      return "";
    }

    function openCard(lemma) {
      const el = document.getElementById("card-" + lemma);
      if (!el) return;
      el.classList.add("open");
      el.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    function renderHeader() {
      document.getElementById("news-title").textContent = episode.title || "Arirang News";
      document.getElementById("news-meta").innerHTML =
        "<span>" + escHtml(episode.date_display || "") + "</span>" +
        "<span>‚Ä¢</span>" +
        "<span>" + escHtml(episode.airtime || "21:55") + "</span>";

      document.getElementById("vocab-count-badge").textContent = "Ïñ¥Ìúò " + vocabData.length + "Í∞ú";

      const dist = { B2:0, C1:0, C2:0 };
      for (const v of vocabData) {
        if (v.cefr_level === "B2") dist.B2++;
        if (v.cefr_level === "C1") dist.C1++;
        if (v.cefr_level === "C2") dist.C2++;
      }
      const max = Math.max(1, dist.B2, dist.C1, dist.C2);
      const chart = document.getElementById("cefr-chart");
      chart.innerHTML = ["B2","C1","C2"].map(k => {
        const h = Math.max(6, Math.round((dist[k] / max) * 56));
        return "<div class='cefr-col'>" +
               "<div class='cefr-bar' style='height:" + h + "px'></div>" +
               "<div>" + k + "</div>" +
               "</div>";
      }).join("");
    }

    function renderAudio() {
      const section = document.getElementById("audio-section");
      const player = document.getElementById("audio-player");
      if (!episode.mp3_filename) {
        section.style.display = "none";
        return;
      }
      player.src = "downloads/" + episode.mp3_filename;
    }

    function renderScript() {
      const box = document.getElementById("script-box");
      const toggle = document.getElementById("script-toggle");
      let text = escHtml(episode.script_text || "");
      if (!text) {
        box.textContent = "Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.";
        toggle.style.display = "none";
        return;
      }

      const sorted = [...vocabData]
        .filter(v => v.word)
        .sort((a,b) => String(b.word).length - String(a.word).length);

      for (const item of sorted) {
        const word = String(item.word || "").trim();
        if (!word) continue;
        const lemma = String(item.lemma || "").trim();
        const cls = cefrClass(item.cefr_level);
        const pattern = new RegExp("\\b(" + word.replace(/[.*+?^${}()|[\\]\\]/g, "\\$&") + ")\\b", "gi");
        text = text.replace(pattern, (m) => {
          return "<mark class='" + cls + "' data-lemma='" + escHtml(lemma) + "'>" + escHtml(m) + "</mark>";
        });
      }

      box.innerHTML = text;
      box.querySelectorAll("mark[data-lemma]").forEach((el) => {
        el.addEventListener("click", () => openCard(el.getAttribute("data-lemma")));
      });

      toggle.addEventListener("click", () => {
        box.classList.toggle("expanded");
        toggle.textContent = box.classList.contains("expanded") ? "Ï†ëÍ∏∞" : "Ï†ÑÏ≤¥Î≥¥Í∏∞";
      });
    }

    function renderCards() {
      const bm = loadBookmarks();
      const grid = document.getElementById("cards-grid");
      grid.innerHTML = vocabData.map((v) => {
        const lemma = escHtml(v.lemma || "");
        const ko = String(v.translation_ko || "").trim() || "ÏÇ¨Ï†Ñ ÎØ∏Îì±Î°ù";
        const deriv = Array.isArray(v.derivatives) ? v.derivatives : [];
        const tags = deriv.map(x => "<span class='tag'>" + escHtml(x) + "</span>").join("");
        const bookmarked = bm[v.word] ? "bookmarked" : "";
        const pressed = bm[v.word] ? "true" : "false";
        return "<article class='v-card " + bookmarked + "' id='card-" + lemma + "'>" +
               "<button class='bookmark-btn' data-word='" + escHtml(v.word) + "' aria-pressed='" + pressed + "'>üîñ</button>" +
               "<div class='card-top'>" +
               "<span class='word'>" + escHtml(v.word || "") + "</span>" +
               "<span class='cefr'>" + escHtml(v.cefr_level || "") + "</span>" +
               "<span class='phonetic'>" + escHtml(v.phonetic || "") + "</span>" +
               "</div>" +
               "<div class='sub'>" + escHtml(v.pos_ko || "") + " ¬∑ ÎπàÎèÑÏ†êÏàò " + escHtml(v.frequency_score) + "</div>" +
               "<div class='card-body'>" +
               "<div class='def-box'>" + escHtml(v.definition_en || "") + "</div>" +
               "<div class='ko'>" + escHtml(ko) + "</div>" +
               "<div class='example'>" + escHtml(v.example_en || "") + "</div>" +
               "<div class='context'>" + escHtml(v.context_sentence || "") + "</div>" +
               "<div class='tags'>" + tags + "</div>" +
               "</div>" +
               "</article>";
      }).join("");

      grid.querySelectorAll(".v-card").forEach((card) => {
        card.addEventListener("click", (ev) => {
          if (ev.target && ev.target.classList.contains("bookmark-btn")) return;
          card.classList.toggle("open");
        });
      });

      grid.querySelectorAll(".bookmark-btn").forEach((btn) => {
        btn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          const word = btn.getAttribute("data-word");
          const store = loadBookmarks();
          store[word] = !store[word];
          if (!store[word]) delete store[word];
          saveBookmarks(store);
          renderCards();
          updateBookmarkCount();
        });
      });
    }

    function updateBookmarkCount() {
      const bm = loadBookmarks();
      const n = Object.keys(bm).length;
      document.getElementById("bookmark-count-badge").textContent = "Î∂ÅÎßàÌÅ¨ " + n + "Í∞ú";
    }

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function buildQuizItems() {
      const withCtx = vocabData.filter(v => v.context_sentence && v.word);
      const picked = shuffle(withCtx).slice(0, 5);
      const words = vocabData.map(v => v.word).filter(Boolean);
      return picked.map((q, idx) => {
        const answer = q.word;
        const wrongPool = shuffle(words.filter(w => w !== answer)).slice(0, 3);
        const choices = shuffle([answer, ...wrongPool]);
        const stem = q.context_sentence.replace(new RegExp("\\b" + answer.replace(/[.*+?^${}()|[\\]\\]/g, "\\$&") + "\\b", "i"), "______");
        return {
          id: idx + 1,
          answer,
          choices,
          stem,
          definition: q.definition_en || ""
        };
      });
    }

    function renderQuiz() {
      const list = document.getElementById("quiz-list");
      const scoreEl = document.getElementById("quiz-score");
      const progress = document.getElementById("quiz-progress");
      const items = buildQuizItems();
      if (!items.length) {
        document.getElementById("quiz-section").style.display = "none";
        return;
      }

      let answered = 0;
      let correct = 0;

      function refresh() {
        scoreEl.textContent = correct + " / " + items.length;
        progress.style.width = Math.round((answered / items.length) * 100) + "%";
      }

      list.innerHTML = items.map((q) => {
        return "<div class='q' data-id='" + q.id + "'>" +
               "<div class='stem'><strong>Q" + q.id + ".</strong> " + escHtml(q.stem) + "</div>" +
               "<div class='choices'>" +
               q.choices.map(c => "<button class='choice' data-choice='" + escHtml(c) + "'>" + escHtml(c) + "</button>").join("") +
               "</div>" +
               "<div class='q-result'></div>" +
               "</div>";
      }).join("");

      list.querySelectorAll(".q").forEach((qEl) => {
        const id = Number(qEl.getAttribute("data-id"));
        const q = items.find(x => x.id === id);
        if (!q) return;
        let done = false;
        qEl.querySelectorAll(".choice").forEach((btn) => {
          btn.addEventListener("click", () => {
            if (done) return;
            done = true;
            answered++;
            const picked = btn.getAttribute("data-choice");
            const result = qEl.querySelector(".q-result");
            qEl.querySelectorAll(".choice").forEach((b) => {
              const val = b.getAttribute("data-choice");
              if (val === q.answer) b.classList.add("correct");
            });
            if (picked === q.answer) {
              correct++;
              btn.classList.add("correct");
              result.textContent = "Ï†ïÎãµ! " + (q.definition ? q.definition : "");
            } else {
              btn.classList.add("wrong");
              result.textContent = "Ïò§Îãµ. Ï†ïÎãµ: " + q.answer + (q.definition ? " | " + q.definition : "");
            }
            refresh();
          });
        });
      });

      refresh();
    }

    renderHeader();
    renderAudio();
    renderScript();
    renderCards();
    updateBookmarkCount();
    renderQuiz();
  </script>
</body>
</html>
